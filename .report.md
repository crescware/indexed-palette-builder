# OKLCH Mode Feature - Current State Report

## Overview

This report summarizes the current codebase structure relevant to adding OKLCH display mode to the Indexed Palette Builder application.

---

## OklchBig Type Implementation Prerequisites

### File Status

`src/models/color/oklch-big.ts` does not exist. This file needs to be created.

### Current Big.js Usage

4 files currently use Big.js:

| File | Pattern |
|------|---------|
| `calc-blend-ratio.ts` | `import Big from "big.js"`, returns `Big` |
| `calc-color.ts` | `import Big from "big.js"`, accepts `chromaScale: Big` |
| `generate-palette.ts` | `import Big from "big.js"`, creates `Big()` values |
| `format-oklch.ts` | `import Big from "big.js"`, uses for multiplication |

### Current Oklch (culori) Usage

7 files import and use `Oklch` from culori:

| File | Usage |
|------|-------|
| `generate-palette-from-oklch-string.ts` | Parses string, passes to generatePalette |
| `generate-palette.ts` | Accepts `Oklch`, includes in `PaletteStep` type |
| `calc-color.ts` | Accepts and returns `Oklch` |
| `select-pattern.ts` | Compares `.l`, `.c`, `.h` against thresholds |
| `detect-strong-correction.ts` | Checks `.l` value |
| `get-closest-shade.ts` | Uses `.h` and `.l` for calculations |
| `format-oklch.ts` | Formats `Oklch` to CSS string |

### Findings

1. **Hue handling**: culori's `Oklch` has `h?: number` (optional). Achromatic colors return `undefined` for hue.

2. **Hex input path**: `generate-palette-from-hex.ts` converts hex to `Oklch` using culori's converter. No original string available for integer-anchored extraction.

3. **PaletteStep type**: Defined in `generate-palette.ts` with `oklch: Oklch` property. This type propagates to all palette display components.

4. **Type import pattern**: Existing files use `import type { Oklch } from "culori"` for type-only imports.

---

## Current Color Handling

### Color Data Structure

Colors are stored in `PaletteStep` type (`src/models/color/generate-palette.ts`) with both hex and OKLCH values:

```typescript
type PaletteStep = Readonly<{
  shade: Shade;
  hex: string;           // Already available
  oklch: Oklch;          // Already available
  isClosest: boolean;
  needsStrongCorrection: boolean;
}>;
```

### Current Display (Hex Only)

| Location | File | Usage |
|----------|------|-------|
| Swatch tooltips | `src/components/color-palette.tsx:99-114` | Shows `${item.shade}: ${item.hex}` |
| CSS export | `src/components/css-export.tsx:12-22` | Generates `--color-{name}-{shade}: {hex};` |

## Existing Settings Architecture

### Context Pattern

The codebase uses a consistent pattern for settings contexts:

1. **Context file**: `src/contexts/{name}/{name}-context.tsx`
   - Creates context with `createContext<ContextValue>()`
   - Provides state signal, setter, and reset functions
   - Persists to localStorage on change
   - Loads from localStorage on mount

2. **Hook file**: `src/contexts/{name}/use-{name}.ts`
   - Exports a custom hook that throws if used outside provider

3. **State type**: `src/models/{name}-state.ts`
   - Defines discriminated union: `{ isLoading: true } | { isLoading: false; value: T }`

4. **Storage key**: `src/models/storage/storage.ts`
   - Centralized storage key definitions with prefix

### Reference Implementation: ShowEdgeShades

The `show-edge-shades` context is a good template:

- **Context**: `src/contexts/show-edge-shades/show-edge-shades-context.tsx`
- **Hook**: `src/contexts/show-edge-shades/use-show-edge-shades.ts`
- **State type**: `src/models/show-edge-shades-state.ts`
- **Storage key**: `storageKeys.showEdgeShades`

### Provider Hierarchy

Providers are nested in `src/app.tsx`:

```
ThemeProvider
  ShowEdgeShadesProvider
    ColorsProvider
      SettingsProvider
        EditModeProvider
```

## Settings UI

The settings popup (`src/components/settings-popup.tsx`) contains:

1. Color Theme (radio buttons: Light/Dark/System)
2. Show edge shades checkbox
3. Reset all data button

The popup uses:
- Radio buttons for mutually exclusive options (theme)
- Checkbox for boolean toggles (show edge shades)

## Key Files Summary

| Category | Files |
|----------|-------|
| Context pattern reference | `src/contexts/show-edge-shades/*` |
| Settings UI | `src/components/settings-popup.tsx` |
| Storage keys | `src/models/storage/storage.ts` |
| App providers | `src/app.tsx` |
| Color display | `src/components/color-palette.tsx`, `src/components/css-export.tsx` |

## Dependencies

- **Solid.js**: Reactive framework with signals
- **culori**: Color conversion library (already provides OKLCH support)
- **localStorage**: For persisting settings

## Design Consideration: Toggle Placement

The color format preference is a **core user preference** - unlike secondary settings (theme, edge shades), it affects the primary output of the application. Users who prefer OKLCH should not need to dig into a settings popup.

### Current Layout Structure

```
src/routes/index.tsx:
+------------------------------------------+
| Header (title, Edit/Settings buttons)    |
+------------------------------------------+
| grid: 7fr               | 3fr            |
| PaletteBuilder          | CssExport      |
| - palette swatches      | - label+copy   |
|                         | - textarea     |
+------------------------------------------+
```

### Affected Areas

The color format setting affects **both** sides of the layout:

| Area | Component | What changes |
|------|-----------|--------------|
| Left (7fr) | PaletteBuilder > ColorPalette | Swatch tooltip text |
| Right (3fr) | CssExport | CSS variable values |

### Placement Conclusion

The toggle must be placed where it implies **global scope** - affecting both areas. Placing it next to CSS export would be misleading since swatches are also affected.

Suitable locations:
- **Header area** - Near Edit/Settings buttons (recommended)
- **Toolbar row** - Between header and main content

